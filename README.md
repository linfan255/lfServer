# Thanos

## 开发日志
thanos按照功能来看，可以分为以下几大部分：

 - 网络框架部分
 - 业务逻辑部分
 - 各种工具类

当一个client发送一个request过来的时候，thanos的三个模块将按照如下顺序处理请求，并产生response返回给client：

 1. 网络框架模块一开始会做一些初始化的工作（configure工具库根据配置文件中的参数进行一些基本参数的配置）。
 2. 网络框架模块接受request数据。
 3. 业务逻辑根据接受到的request数据进行解析，生成response。
 4. 网络框架往client发送response数据。
 5. 至此一个完整的request处理完毕，在此过程中log工具库将根据运行情况生成相关的日志。

下面对这几个部分进行一一介绍

### 网络框架部分
作为一个服务器，这部分显然是性能的重中之重。作为一个好的网络框架，至少应该有以下几个功能/特性：

 - 实现client-server双端的数据通信，这是最为基本的功能。
 - 保证服务器的性能。落实到具体指标上就是保证并发量（qps）。
 - 和业务逻辑模块之间的耦合度应该为0,即和业务逻辑完全分开。

第一个功能参考教科书上最为简单的迭代服务器模型，一个直观的实例就是csapp网络编程一章的web server。但是这种简单的迭代模型显然并不能满足thanos的性能需求，为了保持高并发量，thanos采用的是多线程的threadpool + event loop + non-blocking IO。其中利用epoll来实现同步的事件循环，而且为了保证效率，将套接字设置成non-blocking（设想一个长连接，在传送完一批数据之后，天知道什么时候再次有数据过来！干等着是种及其低效的做法，所以干脆将其设置为non-blocking，这样不管之后有没有数据，IO函数都会直接返回）。同时采取的是one loop one thread的多线程模型，每有一个请求都将分配一个线程来进行业务逻辑处理。如果不对线程数量进行限制，那么成千上万的client访问的时候将会产生成千上万个线程，如此多的线程带来的cpu的调度器花费的over head也是不可忽略的。所以必须使用threadpool对其进行限制。

对于网络框架的事件处理采用Reactor模型，即在event loop当中，仅仅只是做监听工作。发生相关的可读/写，以及新连接到来的事件处理如下：

 1. 发生新的客户端连接，加入到epoll的监听列表中。
 2. 发生可读时间，压入线程池，由线程池内部的线程去做相关的数据读入，业务处理，产生响应报文等。
 3. 发生可写事件，直接将缓存中的数据往套接字写即可。


 
 
 
 

